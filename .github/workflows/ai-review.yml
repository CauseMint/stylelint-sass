name: AI Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} > /tmp/pr.diff
          echo "diff_size=$(wc -c < /tmp/pr.diff)" >> "$GITHUB_OUTPUT"

      - name: Review with Gemini
        if: steps.diff.outputs.diff_size != '0'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          DIFF=$(cat /tmp/pr.diff)

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a code reviewer for a Stylelint plugin project
          (stylelint-sass). Review the following PR diff.

          Project conventions:
          - TypeScript with strict mode
          - ESM (type: module)
          - Vitest for testing
          - Conventional commits
          - 100 char line width
          - Single quotes
          - Rules follow the pattern in src/rules/<name>/index.ts
          - Tests in src/rules/<name>/index.test.ts

          Review for:
          1. Bugs or logic errors
          2. Missing test cases
          3. TypeScript type safety issues
          4. Naming convention violations
          5. Performance concerns

          If you find issues, list them with file path and line.
          If no issues found, say "No issues found."

          Keep your review concise and actionable.
          PROMPT_EOF
          )

          RESPONSE=$(curl -s \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg diff "$DIFF" \
              '{contents: [{parts: [{text: ($prompt + "\n\n```diff\n" + $diff + "\n```")}]}]}')")

          REVIEW=$(echo "$RESPONSE" | jq -r \
            '.candidates[0].content.parts[0].text // "Review failed"')

          gh pr comment "$PR_NUMBER" \
            --body "## Gemini AI Review

          $REVIEW

          ---
          *Automated review by Gemini 2.5 Flash*"
