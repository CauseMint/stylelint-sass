name: AI Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Review with Gemini
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GH_TOKEN: ${{ github.token }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          if [ -z "$GEMINI_API_KEY" ]; then
            echo "::error::GEMINI_API_KEY secret is not configured"
            exit 1
          fi

          gh pr diff "$PR_NUMBER" > /tmp/pr.diff
          DIFF_SIZE=$(wc -c < /tmp/pr.diff)
          if [ "$DIFF_SIZE" -eq 0 ]; then
            echo "::notice::Empty diff, skipping AI review"
            exit 0
          fi

          DIFF_HASH=$(sha256sum /tmp/pr.diff | cut -d' ' -f1)
          echo "Diff hash: $DIFF_HASH"

          EXISTING_COMMENT_ID=$(gh api \
            "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --paginate -q \
            '.[] | select(.body | contains("<!-- gemini-review -->")) | .id' \
            | tail -1)

          if [ -n "$EXISTING_COMMENT_ID" ]; then
            PREVIOUS_HASH=$(gh api \
              "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -q '.body' | sed -n 's/.*<!-- diff-hash:\([a-f0-9]*\) -->.*/\1/p' | head -1)
            if [ "$PREVIOUS_HASH" = "$DIFF_HASH" ]; then
              echo "::notice::Diff unchanged since last review (hash: $DIFF_HASH), skipping"
              exit 0
            fi
          fi

          DIFF=$(cat /tmp/pr.diff)

          PROMPT=$(cat <<'PROMPT_EOF'
          You are a code reviewer for a Stylelint plugin project
          (stylelint-sass). Review the following PR diff.

          Project conventions:
          - TypeScript with strict mode
          - ESM (type: module)
          - Vitest for testing
          - Conventional commits
          - 100 char line width
          - Single quotes
          - Rules follow the pattern in src/rules/<name>/index.ts
          - Tests in src/rules/<name>/index.test.ts

          Review for:
          1. Bugs or logic errors
          2. Missing test cases
          3. TypeScript type safety issues
          4. Naming convention violations
          5. Performance concerns

          If you find issues, list them with file path and line.
          If no issues found, say "No issues found."

          Keep your review concise and actionable.
          PROMPT_EOF
          )

          HTTP_CODE=$(curl -s -o /tmp/gemini-response.json -w '%{http_code}' \
            "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}" \
            -H 'Content-Type: application/json' \
            -d "$(jq -n \
              --arg prompt "$PROMPT" \
              --arg diff "$DIFF" \
              '{contents: [{parts: [{text: ($prompt + "\n\n```diff\n" + $diff + "\n```")}]}]}')")

          if [ "$HTTP_CODE" -ne 200 ]; then
            ERROR=$(jq -r '.error.message // "Unknown error"' /tmp/gemini-response.json)
            echo "::error::Gemini API returned HTTP $HTTP_CODE: $ERROR"
            exit 1
          else
            REVIEW=$(jq -r \
              '.candidates[0].content.parts[0].text // "Review failed: no content in response"' \
              /tmp/gemini-response.json)
          fi

          COMMENT_BODY="<!-- gemini-review --><!-- diff-hash:${DIFF_HASH} -->
          ## Gemini AI Review

          $REVIEW

          ---
          *Automated review by Gemini 2.5 Flash*"

          if [ -n "$EXISTING_COMMENT_ID" ]; then
            gh api \
              "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -X PATCH -f body="$COMMENT_BODY" --silent
            echo "Updated existing review comment #${EXISTING_COMMENT_ID}"
          else
            gh pr comment "$PR_NUMBER" --body "$COMMENT_BODY"
            echo "Created new review comment"
          fi
